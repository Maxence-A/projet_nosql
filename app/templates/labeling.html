{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="text-center mb-5">
        <h2><i class="bi bi-diagram-3-fill me-2"></i>Propagation de Labels</h2>
        <p class="lead text-muted">Détection de communautés et inférence de fonctions biologiques.</p>
    </div>

    <div class="card shadow mb-4 ">
        <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Étape 1 : Détection des Communautés (Clustering)</h5>
            <span class="badge bg-light text-primary">LPA Algorithm</span>
        </div>
        <div class="card-body text-center">
            <p>Charge le graphe en mémoire et identifie les groupes de protéines densément connectés.</p>
            
            <button id="btnDetect" class="btn btn-primary btn-lg" onclick="runDetection()">
                <i class="bi bi-search me-2"></i>Calculer les Communautés
            </button>

            <div id="loaderDetect" class="mt-3" style="display:none;">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted">Analyse du graphe en cours...</p>
            </div>

            <div id="resultsDetect" class="mt-4 text-start" style="display:none;">
                <hr>
                <h4><i class="bi bi-bar-chart-fill me-2"></i> Statistiques des Communautés</h4>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="statTotalComm">0</h3>
                                <small>Communautés</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="statTotalProt">0</h3>
                                <small>Protéines totales</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="statAvgSize">0</h3>
                                <small>Taille moyenne</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="statLabelRate" class="text-info">0%</h3>
                                <small>Taux d'étiquetage actuel</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h5 class="text-secondary"><i class="fa-solid fa-trophy"></i> Top 20 des plus grandes communautés</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mt-2 border">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>ID Communauté</th>
                                    <th>Taille (Protéines)</th>
                                    <th>Taux d'étiquetage</th>
                                    <th>Nb EC uniques</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="topCommunitiesTable">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cardPredict" class="card shadow mb-5" style="opacity: 0.5; pointer-events: none;">
        <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Étape 2 : Stratégie d'Étiquetage</h5>
            <span class="badge bg-light text-primary">Annotation Fonctionnelle</span>
        </div>
        <div class="card-body">
            
            <div class="row text-center mb-4">
                <div class="col-md-6 border-end">
                    <h5 class="text-primary"><i class="bi bi-bullseye me-2"></i>Méthode 1 : Vote Majoritaire</h5>
                    <p class="text-muted small mb-0">
                        Assigne uniquement la fonction la plus fréquente du groupe.<br>
                        <span class="badge bg-success">Haute Précision</span>
                    </p>
                </div>
                <div class="col-md-6">
                    <h5 class="text-warning text-dark"><i class="bi bi-collection me-2"></i>Méthode 2 : Union (APOC)</h5>
                    <p class="text-muted small mb-0">
                        Assigne <em>toutes</em> les fonctions trouvées dans le groupe.<br>
                        <span class="badge bg-warning text-dark">Exhaustivité (Rappel)</span>
                    </p>
                </div>
            </div>

            <div class="text-center mb-4">
                <button id="btnCompare" class="btn btn-outline btn-lg" onclick="runComparison()">
                    <i class="bi bi-arrow-left-right me-2"></i>Lancer la Simulation Comparative
                </button>
                
                <div id="loaderCompare" class="mt-3" style="display:none;">
                    <div class="spinner-border text-success" role="status"></div>
                    <p class="text-muted small mt-2">Simulation des résultats...</p>
                </div>
            </div>

            <div id="resultsCompare" style="display:none;">
                <h6 class="text-secondary mb-3"><i class="fa-solid fa-magnifying-glass"></i> Prévisualisation sur les communautés mixtes :</h6>
                
                <div class="table-responsive mb-4" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Communauté</th>
                                <th>Cibles (Inconnues)</th>
                                <th class="table-primary" style="width: 30%">Résultat Majorité</th>
                                <th class="table-warning" style="width: 30%">Résultat Union</th>
                            </tr>
                        </thead>
                        <tbody id="tableComparisonBody">
                            </tbody>
                    </table>
                </div>
                
                <div id="actionArea" class="alert alert-dark p-4 rounded-3 border-2">
                    
                    <div id="actionButtons" class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <div class="mb-3 mb-md-0">
                            <h5 class="alert-heading"><i class="bi bi-database-fill-gear me-2"></i>Appliquer en Base de Données</h5>
                            <p class="mb-0 small">Choisissez la méthode finale pour écrire <code>ec_numbers_calculated</code>.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="applyMethod('majority')">
                                <i class="bi bi-check-lg me-1"></i>Appliquer Majorité
                            </button>
                            <button class="btn btn-warning" onclick="applyMethod('union')">
                                <i class="bi bi-check-all me-1"></i>Appliquer Union (APOC)
                            </button>
                        </div>
                    </div>

                    <div id="executionProgress" style="display:none;">
                        <h5 class="text-center mb-3"><i class="bi bi-gear-wide-connected fa-spin me-2"></i>Traitement en cours...</h5>
                        <p class="text-center text-muted small" id="progressText">Préparation des données...</p>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="text-center mt-2 small text-muted">Ne fermez pas cette page.</p>
                    </div>

                    <div id="executionSuccess" class="mt-2 text-center" style="display:none;">
                        <div class="alert alert-success border-success">
                            <h4 class="alert-heading"><i class="bi bi-check-circle-fill me-2"></i>Opération Terminée !</h4>
                            <p id="successMessage" class="mb-3">Les données ont été mises à jour.</p>
                            
                            <div class="card d-inline-block text-start p-3 bg-white shadow-sm">
                                <h6 class="border-bottom pb-2"><i class="fa-regular fa-newspaper"></i> Rapport d'exécution</h6>
                                <ul class="list-unstyled mb-0" id="reportList">
                                    </ul>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-success btn-sm" onclick="location.reload()">Recommencer</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/labeling.js') }}"></script>
{% endblock %}